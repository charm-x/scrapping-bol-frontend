<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>History - {{ product_id }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .muted { color: #666; font-size: 0.9em; }
      
      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }
        
        h2 {
          font-size: 1.5rem;
        }
        
        h3 {
          font-size: 1.2rem;
        }
        
        /* Chart container for mobile */
        #chart {
          height: 300px !important;
        }
        
        /* Table responsiveness */
        table {
          font-size: 0.9rem;
        }
        
        th, td {
          padding: 0.5rem 0.25rem;
        }
        
        /* Long product names */
        td:nth-child(3) {
          word-break: break-word;
          max-width: 150px;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h2>Ranking History</h2>
      <p class="muted">Product ID: {{ product_id }}</p>
      <p><a href="/">‚Üê Back</a></p>

      <div style="position: relative; height: 400px; margin: 2rem 0;">
        <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100%;">
          <p>Loading chart data...</p>
        </div>
        <canvas id="chart" style="display: none;"></canvas>
      </div>
      <script>
        async function load() {
          try {
            const res = await fetch(`/api/history/{{ product_id }}`);
            const data = await res.json();
            
            // Hide loading indicator
            document.getElementById('loading').style.display = 'none';
            
            if (data.length === 0) {
              document.getElementById('chart').style.display = 'none';
              document.querySelector('main').innerHTML += '<p style="text-align: center; color: #666; margin: 2rem 0;">No tracking data available yet. Run some checks to see the chart!</p>';
              return;
            }
            
            // Show chart
            document.getElementById('chart').style.display = 'block';
            
            // Process data for chart
            const labels = data.map(d => {
              // Format date for better display
              const date = new Date(d.date);
              return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            });
            
              const values = data.map(d => {
                // Handle null positions (product not found)
                if (d.page_product === null) return null;
                return Number(d.page_product);
              });
            
            const productName = data.length ? (data[0].product_name || data[0].product_id) : '{{ product_id }}';
            
            // Get max position for better Y-axis scaling
            const maxPosition = Math.max(...values.filter(v => v !== null));
            const minPosition = Math.min(...values.filter(v => v !== null));
            
            const ctx = document.getElementById('chart').getContext('2d');
            new Chart(ctx, {
              type: 'line',
                data: {
                  labels,
                  datasets: [{
                    label: 'Absolute Position (Lower = Better)',
                    data: values,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14,165,233,0.1)',
                    borderWidth: 3,
                    pointBackgroundColor: '#0ea5e9',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    spanGaps: false, // Don't connect null values
                    tension: 0.3,
                    fill: true
                  }]
                },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                  title: { 
                    display: true, 
                    text: productName,
                    font: { size: 16, weight: 'bold' }
                  },
                  legend: {
                    display: true,
                    position: 'top'
                  },
                    tooltip: {
                      callbacks: {
                        label: function(context) {
                          if (context.parsed.y === null) {
                            return 'Product not found in search results';
                          }
                          return `Absolute Position: ${context.parsed.y}`;
                        }
                      }
                    }
                },
                scales: {
                  y: {
                    reverse: true, // Lower numbers at top (better rankings)
                    title: { 
                      display: true, 
                      text: 'Absolute Position',
                      font: { size: 14, weight: 'bold' }
                    },
                    ticks: { 
                      precision: 0,
                      stepSize: 1
                    },
                    min: Math.max(1, minPosition - 2),
                    max: maxPosition + 2
                  },
                  x: { 
                    title: { 
                      display: true, 
                      text: 'Date & Time',
                      font: { size: 14, weight: 'bold' }
                    },
                    ticks: {
                      maxRotation: 45,
                      minRotation: 0
                    }
                  }
                },
                interaction: {
                  intersect: false,
                  mode: 'index'
                }
              }
            });
          } catch (error) {
            console.error('Error loading chart:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('chart').style.display = 'none';
            document.querySelector('main').innerHTML += '<p style="color: red; text-align: center; margin: 2rem 0;">Error loading chart data. Please try again.</p>';
          }
        }
        load();
      </script>

      <h3>Raw Data</h3>
      <table role="grid">
        <thead>
          <tr>
            <th>No</th>
            <th>Keyword</th>
            <th>Product Name</th>
            <th>Position</th>
            <th>Absolute Position</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for r in history %}
          <tr>
            <td>{{ r[0] }}</td>
            <td>{{ r[1] }}</td>
            <td>{{ r[3] }}</td>
            <td>{{ r[4] if r[4] is not none else 'Not found' }}</td>
            <td>{{ r[5] if r[5] is not none else 'Not found' }}</td>
            <td>{{ r[6] if r[6] is not none else 'Not found' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="6">No history yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </main>
  </body>
  </html>


